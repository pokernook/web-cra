version: v1beta9

images:
  web:
    image: registry.digitalocean.com/pokernook/web
    tags:
      - sha-${DEVSPACE_GIT_COMMIT}-${DEVSPACE_RANDOM}
    cmd: ["npm", "run", "dev"]
    preferSyncOverRebuild: true
    build:
      docker:
        useBuildKit: true
        options:
          target: build

deployments:
  - name: ingress-nginx
    helm:
      chart:
        name: ingress-nginx
        repo: https://kubernetes.github.io/ingress-nginx
        version: "3.18.0"
      wait: true
  - name: cert-manager
    helm:
      chart:
        name: cert-manager
        repo: https://charts.jetstack.io
        version: "1.1.0"
      wait: true
      values:
        installCRDs: true
  - name: issuer
    kubectl:
      manifests:
        - manifests/issuer/
  - name: pokernook-web
    helm:
      componentChart: true
      values:
        containers:
          - image: registry.digitalocean.com/pokernook/web
            env:
              - name: NEXT_PUBLIC_GRAPHQL_URL
                value: http://local.graph.pokernook.com
              - name: GRAPHQL_SCHEMA_PATH
                value: http://pokernook-graph
        service:
          ports:
            - port: 80
              containerPort: 3000
        ingress:
          ingressClass: nginx
          rules:
            - host: local.pokernook.com
            - host: local.graph.pokernook.com
              serviceName: pokernook-graph
              servicePort: 80
          annotations:
            nginx.ingress.kubernetes.io/enable-cors: "true"
            nginx.ingress.kubernetes.io/cors-allow-origin: "http://local.pokernook.com"

profiles:
  - name: production
    patches:
      - op: remove
        path: images.web.cmd
      - op: remove
        path: images.web.build.docker.options.target

dev:
  ports:
    - imageName: web
      forward:
        - port: 3000
  sync:
    - imageName: web
      initialSync: preferRemote # Initial GraphQL types download
      excludePaths:
        - Dockerfile
        - node_modules
        - .git/
        - /.next/
      uploadExcludePaths:
        - "**/graphql-types.ts"
        - logs
        - "**/*.log"
        - npm-debug.log*
        - yarn-debug.log*
        - yarn-error.log*
        - lerna-debug.log*
        - /coverage
        - devspace.yaml
